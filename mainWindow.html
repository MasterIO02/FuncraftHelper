<!DOCTYPE html>
<html lang="fr">

<head>
    <title> FuncraftHelper </title>
    <link href="./css/style.css" rel="stylesheet">
</head>

<body>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300&display=swap" rel="stylesheet">

    <div class="background"></div>

    <div class="dragHitbox"></div>

    <div id="text-intro" class="text-intro" style="position:fixed; top: 165px; left: 103px"> FuncraftHelper </div>

    <div id="buttons" style="visibility: hidden;">
        <div id="resume-btn" class="resume-btn" style="visibility:hidden; position: fixed; right: 135px; top: 10px">
        </div>
        <div id="pause-btn" class="pause-btn" style="position: fixed; right: 136px; top: 10px"></div>
        <div id="discord-btn" class="discord-btn" style="position: fixed; right: 110px; top: 10px"></div>
        <div id="themes-btn" class="themes-btn" style="position: fixed; right: 85px; top: 10px"></div>
        <div id="settings-btn" class="settings-btn" style="position: fixed; right: 60px; top: 10px"></div>
        <div id="min-btn" class="min-btn" style="position: fixed; right: 35px; top: 10px"></div>
        <div id="close-btn" class="close-btn" style="position: fixed; right: 10px; top: 10px"></div>
    </div>

    <div id="mainObjects" class="mainObjects" style="visibility: hidden; opacity: 0; transition: opacity 500ms;">
        <h4 style="position: fixed; top: 12px; left: 10px; user-select: none" class="text" id="currentTitle"> </h4>
        <textarea id="mainTextArea" rows='21' cols='71' style="resize: none; position: fixed; left: 7px; top: 45px"
            disabled="disabled">
        </textarea>
    </div>

    <script src="./engine/includeHTML.js"></script>
    <div first-launch="firstLaunch.html"></div>

    <div id="settingsObjects" class="settingsObjects" style="visibility: hidden;">
        <h4 class="text" id="settingsTitle" style="position: fixed; top: 12px; left: 10px" class="text"> </h4>

        <label style="position: fixed; top: 50px; left: 40px" class="switch">
            <input type="checkbox" id="useMorgothAPISwitch">
            <div>
                <p class="text" style="position:relative; right: -100px"> Utiliser l'API de LordMorgoth </p>
                <span></span>
            </div>
        </label>

        <textarea spellcheck="false" hidden name="MorgothAPIKeyTextArea" id="MorgothAPIKeyTextArea" rows="1" cols="15"
            style="-webkit-text-security: disc; font-family:Arial, Helvetica, sans-serif ; resize: none; position: fixed; top: 55px; left: 420px"></textarea>
        <p hidden class="text" id="APIKeyText" style="position:fixed; top: 80px; left: 437px; user-select: none;">
            Votre
            clé d'API
        </p>

        <label style="position: fixed; top: 85px; left: 40px;" class="switch">
            <input type="checkbox" id="headlessSwitch">
            <div>
                <p class="text" style="position:fixed; left: 140px; top: 85px"> Mode headless </p>
                <span></span>
            </div>
        </label>

        <textarea spellcheck="false" name="usernameTextArea" id="usernameTextArea" rows="1" cols="10"
            style="font-family:Arial, Helvetica, sans-serif; resize: none; position: fixed; top: 123px; left: 20px;"></textarea>
        <p class="text" style="position:fixed; left:140px; top:120px; user-select: none;"> Pseudo in-game </p>


        <label style="position: fixed; top: 150px; left: 40px;" class="switch">
            <input type="checkbox" id="manualEnter">
            <div>
                <p class="text" style="position:fixed; top: 153px; left: 140px"> Mode manuel si ennemi non trouvé
                </p>
                <span></span>
            </div>
        </label>

        <label style="position: fixed; top: 157px; left: 40px;" class="switch">
            <input type="checkbox" id="pauseEngine">
            <div>
                <p class="text" style="position:fixed; top: 190px; left: 140px"> Pause quand recherche des joueurs
                    terminée
                </p>
                <span></span>
            </div>
        </label>

        <label style="position: fixed; top: 190px; left: 40px;" class="switch">
            <input type="checkbox" id="toggleAdblocker">
            <div>
                <p class="text" style="position:fixed; top: 223px; left: 140px"> Activer l'adblocker
                </p>
                <span></span>
            </div>
        </label>

        <b class="text" style="position:fixed; left: 435px; top: 140px"> Mode de navigation </b>
        <input id="radioMode1btn" type="radio" name="modeRadio" value="1"
            style="position:fixed; top: 170px; left: 435px">
        <input id="radioMode2btn" type="radio" name="modeRadio" value="2"
            style="position:fixed; top: 170px; left: 510px">
        <p class="text" style="position:fixed; left: 450px; top: 165px"> Mode 1 </p>
        <p class="text" style="position:fixed; left: 525px; top: 165px"> Mode 2 </p>


        <button id="benchmark-btn" style="position:fixed; top: 114px; left: 435px;">Benchmark</button>


        <textarea spellcheck="false" name="logFileLocationTextArea" id="logFileLocationTextArea" rows="1" cols="60"
            style="font-family:Arial, Helvetica, sans-serif; resize: none; position: fixed; top: 350px; left: 45px"></textarea>
        <p class="text" style="position:fixed; left: 140px; top: 325px; user-select: none;"> Emplacement du
            latest.log
            de Minecraft
        </p>

        <textarea spellcheck="false" name="chromeLocationTextArea" id="chromeLocationTextArea" rows="1" cols="60"
            style="font-family:Arial, Helvetica, sans-serif; resize: none; position: fixed; top: 280px; left: 45px"></textarea>
        <p class="text" style="position:fixed; left: 140px; top: 255px; user-select: none;"> Emplacement de Chrome
            ou
            Chromium </p>

        <p class="text"
            style="position:fixed; left: 10px; top: 375px; user-select: none; font-size: small; font-style: oblique;">
            Système : </p>
        <p class="text" id="systemType"
            style="position:fixed; left: 70px; top: 375px; user-select: none; font-size: small; font-style: oblique;">
            Inconnu </p>

        <div class="help-tip" style="position: fixed; top: 89px; left: 255px">
            <p>Si cette option est désactivée, la vérification des statistiques sera faite en étant visible. Par
                défaut
                activée donc invisible.</p>
        </div>

        <div class="help-tip" style="position: fixed; top: 155px; left: 403px">
            <p>Si cette option est activée et qu'un joueur ennemi n'est pas détecté automatiquement, une fenêtre
                s'ouvrira pour entrer son pseudo manuellement. (MODES 1v1 SEULEMENT)</p>
        </div>

        <div class="help-tip" style="position: fixed; top: 52px; left: 352px">
            <p>L'API de LordMorgoth permet d'avoir une recherche de statistiques quasi instantanée. Rendez vous sur
                lordmorgoth.net pour demander une clé (c'est gratuit !, MODES 1v1 SEULEMENT)</p>
        </div>

        <div class="help-tip" style="position: fixed; top: 255px; left: 432px">
            <p>Chrome est nécessaire pour rechercher les statistiques des joueurs adverses.</p>
        </div>

        <div class="help-tip" style="position: fixed; top: 115px; left: 515px;">
            <p> Le benchmark permet de savoir en combien de temps votre ordinateur sera capable d'aller chercher les
                statistiques des adversaires.</p>
        </div>

        <div class="help-tip" style="position: fixed; top: 225px; left: 275px;">
            <p> L'adblocker fait gagner en performances (-1 seconde de recherche environ) mais
                peut causer des problèmes de chargement infini, et ne rémunère pas Funcraft :(</p>
        </div>



        <div id="enterUsernameWindow" style="visibility: hidden">
            <div class="background" style="position: fixed; width: 300px; height: 100px; left: 150px; top: 75px">
            </div>
            <button id="close-btn-enterUsernameWindow" style="position:fixed; left: 400px; top: 82px">passer</button>
            <textarea spellcheck="false" id="manualUsernameTextarea" rows="1" cols="15"
                style="font-family:Arial, Helvetica, sans-serif ; resize: none; position: fixed; user-select: none; left:230px; top:145px"></textarea>
            <p
                style="font-size: small; position:fixed; left: 165px; top:80px; user-select: none; color: darkslategrey;">
                Le
                joueur
                n'a pas été
                trouvé. <br> Entrez son pseudo manuellement <br> pour avoir ses stats.</p>
        </div>


        <div id="benchmarkObjects" style="visibility: hidden;">
            <b class="text" id="bench-test-1" style="position:fixed; left: 50px; top: 60px; user-select: none;">Test
                1 :
                En cours...</b>
            <b class="text" id="bench-test-2" style="position:fixed; left: 50px; top: 100px; user-select: none;">Test 2
                : En cours...</b>
            <b class="text" id="bench-test-3" style="position:fixed; left: 50px; top: 140px; user-select: none;">Test 3
                : En cours...</b>
            <b class="text" id="bench-test-all" style="position:fixed; left: 50px; top: 180px; user-select: none;"></b>

            <button id="close-benchmark-btn"
                style="position:fixed; top: 220px; left: 275px; visibility: hidden;">Fermer</button>
        </div>


</body>


<script>
    const Store = require('electron-store');
    const store = new Store();
    const sharedVars = require('./engine/sharedVars')

    // Initialisation GUI
    function initGUI() {
        const { BrowserWindow } = require('electron').remote

        // Change la taille du mainTextArea, texte d'intro, et "?" des help-tip sur Windows
        if (store.get('systemType') == 'win32') {
            document.getElementById("mainTextArea").rows = 23
            document.styleSheets[0].addRule('.help-tip:before', 'top: -2px;');
            document.getElementById("text-intro").style.top = "155px"
            document.getElementById("text-intro").style.left = "110px"
        }

        // Chargeur de thème
        function loadCSS(load) {
            const path = require('path')
            var head = document.getElementsByTagName("head")[0]
            var link = document.createElement("link")
            link.rel = "stylesheet"
            link.type = "text/css"
            link.href = path.join(__dirname, "/css/" + load + ".css")
            head.appendChild(link)
        }

        // Chargement du thème au démarrage
        if (store.get('theme') == 'default') {
            loadCSS("default")
        } else if (store.get('theme') == 'dark') {
            loadCSS("dark")
        }

        // Actions boutons principaux
        document.getElementById("close-btn-enterUsernameWindow").addEventListener("click", (e) => {
            document.getElementById("enterUsernameWindow").style.visibility = "hidden"
        })

        document.getElementById("min-btn").addEventListener("click", (e) => {
            var window = BrowserWindow.getFocusedWindow();
            window.minimize();
        })

        document.getElementById("close-btn").addEventListener("click", (e) => {
            var window = BrowserWindow.getFocusedWindow();
            window.close();
        })

        document.getElementById("discord-btn").addEventListener("click", (e) => {
            require('electron').shell.openExternal('https://discord.gg/QfbZBPA')
        })

        document.getElementById("settings-btn").addEventListener("click", (e) => {
            if (document.getElementById("settingsObjects").style.visibility == "hidden") {
                document.getElementById("settingsTitle").innerHTML = `FuncraftHelper ${sharedVars.fhVersion} - Paramètres`
                document.getElementById("mainObjects").style.visibility = "hidden"
                document.getElementById("settingsObjects").style.visibility = "visible"
            } else {
                document.getElementById("settingsObjects").style.visibility = "hidden"
                document.getElementById("mainObjects").style.visibility = "visible"
            }
        })

        document.getElementById("pause-btn").addEventListener("click", (e) => {
            const pauseEngine = require('./engine/checkGame').pauseEngine
            pauseEngine()
            document.getElementById("pause-btn").style.transition = "paused"
            document.getElementById("pause-btn").style.visibility = "hidden"
            document.getElementById("resume-btn").style.visibility = "visible"
            document.getElementById("pause-btn").style.transition = "running"
        })

        document.getElementById("resume-btn").addEventListener("click", (e) => {
            const checkGamemode = require('./engine/checkGame').checkGamemode
            checkGamemode()
            document.getElementById("resume-btn").style.transition = "paused"
            document.getElementById("resume-btn").style.visibility = "hidden"
            document.getElementById("pause-btn").style.visibility = "visible"
            document.getElementById("resume-btn").style.transition = "running"
        })

        // Bouton benchmark -> lancement du benchmark
        document.getElementById("benchmark-btn").addEventListener("click", (e) => {
            const pauseEngine = require('./engine/checkGame').pauseEngine
            pauseEngine()
            document.getElementById("currentTitle").innerHTML = `FuncraftHelper ${sharedVars.fhVersion} - Benchmark en cours`
            document.getElementById("currentTitle").style.visibility = "visible"
            document.getElementById("buttons").style.visibility = "hidden"
            document.getElementById("resume-btn").style.visibility = "hidden"
            document.getElementById("settingsObjects").style.visibility = "hidden"
            document.getElementById("mainObjects").style.visibility = "hidden"
            document.getElementById("benchmarkObjects").style.visibility = "visible"
            const launchBenchmark = require('./engine/benchmark').launchBenchmark
            launchBenchmark()
        })

        // Bouton fermer benchmark
        document.getElementById("close-benchmark-btn").addEventListener("click", (e) => {
            document.getElementById("currentTitle").innerHTML = `FuncraftHelper ${sharedVars.fhVersion} - En pause`
            document.getElementById("currentTitle").style.visibility = "unset"
            document.getElementById("benchmarkObjects").style.visibility = "hidden"
            document.getElementById("mainObjects").style.visibility = "visible"
            document.getElementById("buttons").style.visibility = "visible"
            document.getElementById("resume-btn").style.visibility = "visible"
            document.getElementById("close-benchmark-btn").style.visibility = "hidden"
            document.getElementById("bench-test-1").innerHTML = "Test 1 : En cours..."
            document.getElementById("bench-test-2").innerHTML = "Test 2 : En cours..."
            document.getElementById("bench-test-3").innerHTML = "Test 3 : En cours..."
            document.getElementById("bench-test-all").innerHTML = ""
        })

        // Bouton thèmes
        document.getElementById("themes-btn").addEventListener("click", (e) => {
            if (store.get('theme') == 'default') {
                loadCSS("dark")
                store.set('theme', 'dark')
            } else if (store.get('theme') == 'dark') {
                loadCSS("default")
                store.set('theme', "default")
            }
        })

        // Initialisation du system type
        document.getElementById("systemType").innerHTML = store.get('systemType')

        // Script pour switch MorgothAPI
        if (store.get('useMorgothAPI') == true) {
            document.getElementById("useMorgothAPISwitch").checked = true
            document.getElementById("APIKeyText").hidden = false
            document.getElementById("MorgothAPIKeyTextArea").hidden = false
        } else {
            document.getElementById("useMorgothAPISwitch").checked = false
        }

        document.getElementById("useMorgothAPISwitch").addEventListener("click", (e) => {
            if (store.get('useMorgothAPI') == true) {
                store.set('useMorgothAPI', false)
                document.getElementById("APIKeyText").hidden = true
                document.getElementById("MorgothAPIKeyTextArea").hidden = true

            } else {
                store.set('useMorgothAPI', true)
                document.getElementById("APIKeyText").hidden = false
                document.getElementById("MorgothAPIKeyTextArea").hidden = false
            }
        })

        // Script pour switch headless
        if (store.get('headless') == true) {
            document.getElementById("headlessSwitch").checked = true
        } else {
            document.getElementById("headlessSwitch").checked = false
        }

        document.getElementById("headlessSwitch").addEventListener("click", (e) => {
            if (store.get('headless') == true) {
                store.set('headless', false)
            } else {
                store.set('headless', true)
            }
        })

        // Script pour switch manualEnter
        if (store.get('manualEnter') == true) {
            document.getElementById("manualEnter").checked = true
        } else {
            document.getElementById("manualEnter").checked = false
        }

        document.getElementById("manualEnter").addEventListener("click", (e) => {
            if (store.get('manualEnter') == true) {
                store.set('manualEnter', false)
            } else {
                store.set('manualEnter', true)
            }
        })

        // Script pour switch pauseEngine
        if (store.get('pauseEngine') == true) {
            document.getElementById("pauseEngine").checked = true
        } else {
            document.getElementById("pauseEngine").checked = false
        }

        document.getElementById("pauseEngine").addEventListener("click", (e) => {
            if (store.get('pauseEngine') == true) {
                store.set('pauseEngine', false)
            } else {
                store.set('pauseEngine', true)
            }
        })

        // Script pour boutons radio modes
        if (store.get('modeNumber') == 1) {
            document.getElementById("radioMode1btn").checked = true
        }
        if (store.get('modeNumber') == 2) {
            document.getElementById("radioMode2btn").checked = true
        }
        document.getElementById("radioMode1btn").addEventListener("click", (e) => {
            store.set('modeNumber', 1)
        })
        document.getElementById("radioMode2btn").addEventListener("click", (e) => {
            store.set('modeNumber', 2)
        })

        // Script pour switch toggleAdblocker
        if (store.get('adblocker') == true) {
            document.getElementById("toggleAdblocker").checked = true
        } else {
            document.getElementById("toggleAdblocker").checked = false
        }

        document.getElementById("toggleAdblocker").addEventListener("click", (e) => {
            if (store.get('adblocker') == true) {
                store.set('adblocker', false)
            } else {
                store.set('adblocker', true)
            }
        })

        // Script pour textarea username
        document.getElementById("usernameTextArea").value = store.get('username')
        document.getElementById("usernameTextArea").addEventListener("input", (e) => {
            store.set('username', document.getElementById('usernameTextArea').value)
        })

        // Script pour textarea morgothAPIkey
        document.getElementById("MorgothAPIKeyTextArea").value = store.get('MorgothAPIKey')
        document.getElementById("MorgothAPIKeyTextArea").addEventListener("input", (e) => {
            store.set('MorgothAPIKey', document.getElementById('MorgothAPIKeyTextArea').value)
        })

        // Script pour emplacement latest.log
        document.getElementById("logFileLocationTextArea").value = store.get('logFileLocation')
        document.getElementById("logFileLocationTextArea").addEventListener("input", (e) => {
            store.set('logFileLocation', document.getElementById('logFileLocationTextArea').value)
        })

        // Script pour emplacement chrome
        document.getElementById("chromeLocationTextArea").value = store.get('chromeLocation')
        document.getElementById("chromeLocationTextArea").addEventListener("input", (e) => {
            store.set('chromeLocation', document.getElementById('chromeLocationTextArea').value)
        })



        // Lancement intro
        window.onload = function () {
            setTimeout(function () {
                document.getElementById("text-intro").style.opacity = 0
                setTimeout(function () {
                    // Si c'est le premier démarrage on cache le mainTextArea sinon on l'affiche
                    document.getElementById("mainObjects").style.visibility = "visible"
                    document.getElementById("mainObjects").style.opacity = 1
                    if (store.get('firstLaunch') == false) {
                        document.getElementById("buttons").style.visibility = "visible"
                    } else {
                        document.getElementById("close-btn").style.visibility = "visible"
                        document.getElementById("mainTextArea").style.visibility = "hidden"
                        document.getElementById("currentTitle").innerHTML = `FuncraftHelper ${sharedVars.fhVersion} - Premier démarrage`
                        document.getElementById("firstLaunch").style.visibility = "visible"
                    }
                }, 500);
            }, 3200);
        }

        // Fin scripts
        document.getElementById("mainTextArea").value = '           - https://github.com/MasterIO02/FuncraftHelper -\n';
        document.getElementById("mainTextArea").value += "      - Faites moi part de vos suggestions / bugs sur GitHub ! -\n\n"
        document.getElementById("manualUsernameTextarea").focus()
    }
    initGUI()

    // Check si une mise à jour est disponible
    const fetch = require("node-fetch");
    fetch("https://api.github.com/repos/MasterIO02/FuncraftHelper/releases/latest")
        .then(res => res.json())
        .then((json) => {
            if (json.tag_name != sharedVars.fhVersion && json.documentation_url != "https://developer.github.com/v3/#rate-limiting") {
                document.getElementById("mainTextArea").value += "\nLa version " + json.tag_name + " de FuncraftHelper est disponible !\n";
                document.getElementById("mainTextArea").value += "Téléchargez-la pour disposer de corrections de bugs, optis, et nouvelles fonctionnalités !\n";
                document.getElementById("mainTextArea").value += "https://github.com/MasterIO02/FuncraftHelper/releases\n\n";
            }
        })


    // Check si c'est la première fois que FH est lancé, si oui, on ouvre le tuto de configuration, si non, FH commencera la recherche
    if (store.get('firstLaunch') == undefined) {
        document.getElementById("mainObjects").style.visibility = "hidden"
        const initFirstLaunch = require('./engine/firstLaunch').initFirstLaunch
        includeHTML(function () {
            initFirstLaunch()
        }, "first-launch");
    } else {
        if (store.get('systemType') == "darwin") {
            document.getElementById("mainTextArea").value += "MacOS n'est pas officiellement supporté par FuncraftHelper. Merci de ne pas faire de rapport de bugs pour ce système.\n\n";
        } else if (store.get('systemType') == "win32") {
            const isElevated = require('is-elevated');
            (async () => {
                var isAdmin = await isElevated()
                if (isAdmin == false) {
                    document.getElementById("mainTextArea").value += "Lancez FuncraftHelper en tant qu'administrateur pour possiblement de meilleures performances.\n\n"
                }
            })()
        }
        const checkGamemode = require('./engine/checkGame').checkGamemode
        checkGamemode()
    }


    // Check si enter est appuyé, pour check les stats de quelqu'un manuellement
    document.getElementById("enterUsernameWindow").addEventListener("keypress", (e) => {
        if (e.key === 'Enter') {
            sharedVars.playerUsername = document.getElementById("manualUsernameTextarea").value
            document.getElementById("manualUsernameTextarea").value = ""
            document.getElementById("enterUsernameWindow").style.visibility = "hidden"
            document.getElementById("mainTextArea").value += `Recherche des stats de ${sharedVars.playerUsername} ...\n`
            if (store.get('useMorgothAPI') == false) {
                const navigatePlayer = require('./engine/navigatePlayer').navigatePlayer
                navigatePlayer()
            } else {
                const navigateMorgothAPI = require('./engine/navigateMorgothAPI').navigateMorgothAPI
                navigateMorgothAPI()
            }
        }
    })

    // Check toutes les 5 minutes si le fichier de log de Minecraft est trop gros pour continuer a bien fonctionner.
    // Si il est plus gros que 75kb, un avertissement sera envoyé dans le mainTextArea pour demander a l'utilisateur de redémarrer Minecraft.
    setInterval(function () {
        const fs = require("fs")
        fs.stat(store.get('logFileLocation'), (err, fileStats) => {
            console.log(fileStats.size)
            if (err) {
                console.log(err)
            } else {
                if (fileStats.size >= 100000) {
                    var fileSize = (fileStats.size / Math.pow(1024, 1)).toFixed(2)
                    console.log(fileSize)
                    document.getElementById("mainTextArea").value += `La taille du fichier de log de Minecraft est de ${fileSize}kb. Il est recommandé de relancer Minecraft pour de meilleures performances de FuncraftHelper.\n`
                    textarea.scrollTop = textarea.scrollHeight
                }
            }
        })
    }, 300000)

</script>

</html>